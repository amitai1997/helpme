{% extends "base.html" %}

{% load static %}
{% load leaflet_tags %}
{% leaflet_css %}
{% leaflet_js %}
{% block title %}
    Custom Volunteer Map
{% endblock title %}
{% block content %}

    {% load ratings %}

    <link rel="stylesheet" type="text/css" href="{% static 'leaflet/leaflet.css' %}">
    <script type="text/javascript" src="{% static 'leaflet/leaflet.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{% static 'star-ratings/css/star-ratings.css' %}">
    <script type="text/javascript" src="{% static 'star-ratings/js/dist/star-ratings.min.js' %}"></script>
    </head>
<body>
    <div id="map" style="width: 100%; height: 500px;"></div>
    <script type="text/javascript">
        var map = L.map('map').setView([{{ volunteers.0.location.y }}, {{ volunteers.0.location.x }}], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        {% for volunteer in volunteers %}
        var popupContent = '<table>' +
                '<tr><td>ID:</td><td id="ID{{ volunteer.pk }}">{{ volunteer.id }}</td></tr>' +
                '<tr><td>Name:</td><td id="name{{ volunteer.pk }}">{{ volunteer.profile.user.name }}</td></tr>' +
                '<tr><td>Email:</td><td id="email{{ volunteer.pk }}">{{ volunteer.profile.user.email }}</td></tr>' +
                '<tr><td>Available:</td><td id="availability{{ volunteer.pk }}">{{ volunteer.availability_status }}</td></tr>' +
                '<tr><td>Phone:</td><td id="phone{{ volunteer.pk }}">{{ volunteer.contact_information }}</td></tr>' +
                '<tr><td>Weapon:</td><td id="weapon{{ volunteer.pk }}">{{ volunteer.carrying_weapon }}</td></tr>' +
                '<tr><td>License:</td><td id="license{{ volunteer.pk }}">{{ volunteer.driving_license }}</td></tr>' +
                '<tr><td>Rating:</td><td id="rating{{ volunteer.pk }}">{{ volunteer.ratings.avarage }}</td></tr>' +
                '</table>'

                console.log("{{ volunteer.average_rating }}")
            L.marker([{{ volunteer.location.y }}, {{ volunteer.location.x }}], {volunteerPk: {{ volunteer.pk }}}).addTo(map).bindPopup(popupContent);
        {% endfor %}

        // Function to update specific fields with JSON data
        function updateVolunteers() {
            $.ajax({

                // TODO change to relative path
                url: 'http://localhost:8001/emergency/volunteers/update/',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    var volunteers = JSON.parse(data.volunteers);

                    volunteers.forEach(function (volunteer) {
                        // Update specific fields based on the volunteer's primary key (pk)
                        $('#availability' + volunteer.pk).text(volunteer.fields.availability_status);
                        $('#phone' + volunteer.pk).text(volunteer.fields.contact_information);
                        $('#weapon' + volunteer.pk).text(volunteer.fields.carrying_weapon);
                        $('#license' + volunteer.pk).text(volunteer.fields.driving_license);

                        // Extract the latitude and longitude from the location field
                        var locationString = volunteer.fields.location;
                        var coordinates = locationString.match(/\(([^)]+)\)/)[1].split(' ');
                        var latitude = parseFloat(coordinates[1]);
                        var longitude = parseFloat(coordinates[0]);

                        // Update the marker's position on the map
                        updateMarkerPosition(volunteer.pk, latitude, longitude);
                    });
                },
                error: function(xhr, status, error) {
                    console.log('Error fetching data: ' + error);
                }
            });
        }

        function updateMarkerPosition(volunteerPk, newLatitude, newLongitude) {
            // Find the existing marker and update its position
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    if (layer.options.volunteerPk === volunteerPk) {
                        layer.setLatLng([newLatitude, newLongitude]);
                    }
                }
            });
        }

        // Call the updateVolunteers function to initially load markers and data
        updateVolunteers();

        // Automatically update volunteers at a regular interval (e.g., every 60 seconds)
        setInterval(updateVolunteers, 4000);  // Adjust the interval as needed
    </script>
{% endblock content %}