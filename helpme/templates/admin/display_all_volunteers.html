{% extends "base.html" %}

{% load static %}
{% load leaflet_tags %}
{% leaflet_css %}
{% leaflet_js %}
{% block title %}
    Custom Volunteer Map
{% endblock title %}
{% block content %}

    {% load ratings %}

    <link rel="stylesheet" type="text/css" href="{% static 'leaflet/leaflet.css' %}">
    <script type="text/javascript" src="{% static 'leaflet/leaflet.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{% static 'star-ratings/css/star-ratings.css' %}">
    <script type="text/javascript" src="{% static 'star-ratings/js/dist/star-ratings.min.js' %}"></script>
    </head>
<body>
    <div id="map" style="width: 100%; height: 500px;"></div>
    <script type="text/javascript">
        var map = L.map('map').setView([{{ volunteers.0.location.y }}, {{ volunteers.0.location.x }}], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        {% for volunteer in volunteers %}
        var popupContent = '<table>' +
            '<tr><td>ID:</td><td id="ID{{ volunteer.id }}">{{ volunteer.id }}</td></tr>' +
            '<tr><td>Name:</td><td id="name{{ volunteer.id }}">{{ volunteer.profile.user.name }}</td></tr>' +
            '<tr><td>Email:</td><td id="email{{ volunteer.id }}">{{ volunteer.profile.user.email }}</td></tr>' +
            '<tr><td>Available:</td><td id="availability{{ volunteer.id }}">{{ volunteer.availability_status }}</td></tr>' +
            '<tr><td>Phone:</td><td id="phone{{ volunteer.id }}">{{ volunteer.contact_information }}</td></tr>' +
            '<tr><td>Weapon:</td><td id="weapon{{ volunteer.id }}">{{ volunteer.carrying_weapon }}</td></tr>' +
            '<tr><td>License:</td><td id="license{{ volunteer.id }}">{{ volunteer.driving_license }}</td></tr>';
    
        // Render the ratings data from context
        popupContent += '<tr><td>Rating:</td><td id="rating{{ volunteer.id }}">{{ volunteer.average_rating }}</td></tr>';
    
        popupContent += '<div id="star-rating-{{ volunteer.id }}"></div>';
        // Initialize the star rating widget for the current volunteer
        $(document).ready(function () {
            var averageRating = parseFloat("{{ volunteer.average_rating|default:0 }}");
            $("#star-rating-{{ volunteer.id }}").rating({
                min: 0,
                max: 5,
                step: 1,
                size: 'xs',
                readonly: false,
                showClear: false,
                showCaption: false,
            });
            $("#star-rating-{{ volunteer.id }}").rating('update', averageRating);
        });
    
        popupContent += '</table>';
    
        L.marker([{{ volunteer.location.y }}, {{ volunteer.location.x }}], {volunteerId: {{ volunteer.id }}}).addTo(map).bindPopup(popupContent);
    {% endfor %}

        // Function to update specific fields with JSON data
        function updateVolunteers() {
            $.ajax({
                // TODO change to relative path
                url: 'http://localhost:8001/emergency/volunteers/update/',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    var volunteers = JSON.parse(data.volunteers);

                    volunteers.forEach(function (volunteer) {
                        // Update specific fields based on the volunteer's primary key (id)
                        $('#availability' + volunteer.id).text(volunteer.availability_status);
                        $('#phone' + volunteer.id).text(volunteer.contact_information);
                        $('#weapon' + volunteer.id).text(volunteer.carrying_weapon);
                        $('#license' + volunteer.id).text(volunteer.driving_license);
                       
                        // Check if the rating is not null before updating the element
                        if (volunteer.rating && volunteer.rating.average) {
                            $('#rating' + volunteer.id).text(volunteer.rating.average);
                        }
                        // Extract the latitude and longitude from the location field
                        var locationString = volunteer.location;
                        var coordinates = locationString.split(',');
                        var latitude = parseFloat(coordinates[0]);
                        var longitude = parseFloat(coordinates[1]);

                        // Update the marker's position on the map
                        updateMarkerPosition(volunteer.id, latitude, longitude);
                    });
                },
                error: function(xhr, status, error) {
                    console.log('Error fetching data: ' + error);
                }
            });
        }

        function updateMarkerPosition(volunteerId, newLatitude, newLongitude) {
            // Find the existing marker and update its position
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    if (layer.options.volunteerId === volunteerId) {
                        layer.setLatLng([newLatitude, newLongitude]);
                    }
                }
            });
        }

        // Call the updateVolunteers function to initially load markers and data
        updateVolunteers();

        // Automatically update volunteers at a regular interval (e.g., every 60 seconds)
        setInterval(updateVolunteers, 4000);  // Adjust the interval
</script>
{% endblock content %}